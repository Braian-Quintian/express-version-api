import { defineConfig } from 'tsup';

const common = {
  // ─────────────────────────────────────────────────────────────────
  // Source maps
  // ─────────────────────────────────────────────────────────────────
  sourcemap: true,

  // ─────────────────────────────────────────────────────────────────
  // Dividir código en chunks (mejor tree-shaking)
  // ─────────────────────────────────────────────────────────────────
  splitting: false,

  // ─────────────────────────────────────────────────────────────────
  // Minificación (desactivada para mejor debugging)
  // ─────────────────────────────────────────────────────────────────
  minify: false,

  // ─────────────────────────────────────────────────────────────────
  // Target de JavaScript
  // ─────────────────────────────────────────────────────────────────
  target: 'es2022',

  // ─────────────────────────────────────────────────────────────────
  // Plataforma
  // ─────────────────────────────────────────────────────────────────
  platform: 'node',

  // ─────────────────────────────────────────────────────────────────
  // Directorio de salida
  // ─────────────────────────────────────────────────────────────────
  outDir: 'dist',

  // ─────────────────────────────────────────────────────────────────
  // No incluir dependencias externas en el bundle
  // ─────────────────────────────────────────────────────────────────
  external: ['express'],

  // ─────────────────────────────────────────────────────────────────
  // Shims para __dirname y __filename en ESM
  // ─────────────────────────────────────────────────────────────────
  shims: true,

  // ─────────────────────────────────────────────────────────────────
  // Treeshake para eliminar código no usado
  // ─────────────────────────────────────────────────────────────────
  treeshake: true,

  // ─────────────────────────────────────────────────────────────────
  // Banner con información del paquete
  // ─────────────────────────────────────────────────────────────────
  banner: {
    js: '/* express-version-api - MIT License - https://github.com/Braian-Quintian/express-version-api */',
  },

  // ─────────────────────────────────────────────────────────────────
  // Configuración de esbuild
  // ─────────────────────────────────────────────────────────────────
  esbuildOptions(options: { charset?: string }) {
    options.charset = 'utf8';
  },
} as const;

export default defineConfig([
  {
    ...common,
    // ───────────────────────────────────────────────────────────────
    // ESM entry (includes default export)
    // ───────────────────────────────────────────────────────────────
    entry: {
      index: 'src/index.esm.ts',
    },
    format: ['esm'],
    dts: {
      entry: {
        index: 'src/index.esm.ts',
      },
    },
    clean: true,
    outExtension() {
      return { js: '.js' };
    },
  },
  {
    ...common,
    // ───────────────────────────────────────────────────────────────
    // CJS entry (named exports only to avoid mixed-export warning)
    // ───────────────────────────────────────────────────────────────
    entry: {
      index: 'src/index.ts',
    },
    format: ['cjs'],
    dts: false,
    clean: false,
    outExtension() {
      return { js: '.cjs' };
    },
  },
]);

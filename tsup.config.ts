import { defineConfig } from 'tsup';

export default defineConfig({
  // ─────────────────────────────────────────────────────────────────
  // Entrada
  // ─────────────────────────────────────────────────────────────────
  entry: ['src/index.ts'],

  // ─────────────────────────────────────────────────────────────────
  // Formatos de salida
  // ─────────────────────────────────────────────────────────────────
  format: ['cjs', 'esm'],

  // ─────────────────────────────────────────────────────────────────
  // Tipos
  // ─────────────────────────────────────────────────────────────────
  dts: true,

  // ─────────────────────────────────────────────────────────────────
  // Source maps
  // ─────────────────────────────────────────────────────────────────
  sourcemap: true,

  // ─────────────────────────────────────────────────────────────────
  // Limpiar directorio de salida antes de build
  // ─────────────────────────────────────────────────────────────────
  clean: true,

  // ─────────────────────────────────────────────────────────────────
  // Dividir código en chunks (mejor tree-shaking)
  // ─────────────────────────────────────────────────────────────────
  splitting: false,

  // ─────────────────────────────────────────────────────────────────
  // Minificación (desactivada para mejor debugging)
  // ─────────────────────────────────────────────────────────────────
  minify: false,

  // ─────────────────────────────────────────────────────────────────
  // Target de JavaScript
  // ─────────────────────────────────────────────────────────────────
  target: 'es2022',

  // ─────────────────────────────────────────────────────────────────
  // Plataforma
  // ─────────────────────────────────────────────────────────────────
  platform: 'node',

  // ─────────────────────────────────────────────────────────────────
  // Directorio de salida
  // ─────────────────────────────────────────────────────────────────
  outDir: 'dist',

  // ─────────────────────────────────────────────────────────────────
  // Extensiones de archivos por formato
  // ─────────────────────────────────────────────────────────────────
  outExtension({ format }) {
    return {
      js: format === 'cjs' ? '.cjs' : '.js',
    };
  },

  // ─────────────────────────────────────────────────────────────────
  // No incluir dependencias externas en el bundle
  // ─────────────────────────────────────────────────────────────────
  external: ['express'],

  // ─────────────────────────────────────────────────────────────────
  // Shims para __dirname y __filename en ESM
  // ─────────────────────────────────────────────────────────────────
  shims: true,

  // ─────────────────────────────────────────────────────────────────
  // Treeshake para eliminar código no usado
  // ─────────────────────────────────────────────────────────────────
  treeshake: true,

  // ─────────────────────────────────────────────────────────────────
  // Banner con información del paquete
  // ─────────────────────────────────────────────────────────────────
  banner: {
    js: '/* express-version-api - MIT License - https://github.com/Braian-Quintian/express-version-api */',
  },

  // ─────────────────────────────────────────────────────────────────
  // Configuración de esbuild
  // ─────────────────────────────────────────────────────────────────
  esbuildOptions(options) {
    options.charset = 'utf8';
  },
});
